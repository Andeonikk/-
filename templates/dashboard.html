{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет</title>
    <link rel="stylesheet" href="{% static 'dashboard.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Личный кабинет</h2>

        <p><strong>Название организации:</strong> {{ org_data.name_organ }}</p>
        <p><strong>ИНН:</strong> {{ org_data.inn }}</p>
        <p><strong>КПП:</strong> {{ org_data.kpp }}</p>
        <p><strong>ОГРН:</strong> {{ org_data.ogrn }}</p>
        <p><strong>Юридический адрес:</strong><br>{{ org_data.address }}</p>

        <!-- Кнопка "Редактировать данные" -->
        <a href="{% url 'accounts:edit_org_data' %}" class="btn btn-primary mb-2">
            Редактировать данные
        </a>

        <!-- Кнопка "Банковские реквизиты" -->
        <a href="{% url 'accounts:bank_details_edit' %}" class="btn btn-info mb-2">
            Банковские реквизиты
        </a>

        <!-- НОВАЯ КНОПКА: "Создать счёт" -->
        <a href="#create-invoice" class="btn btn-success mb-2" data-bs-toggle="modal">
            Создать счёт
        </a>

        <a href="{% url 'accounts:logout' %}" class="btn btn-secondary">Выйти</a>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО: Создание счёта -->
    <div class="modal fade" id="create-invoice" tabindex="-1" aria-labelledby="createInvoiceLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createInvoiceLabel">Создание счёта</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Панель 1: Номер счёта и срок оплаты -->
                    <div class="card mb-3">
                        <div class="card-header">Данные счёта</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="invoiceNumber" class="form-label">Номер счёта</label>
                                <input type="text" class="form-control" id="invoiceNumber">
                            </div>
                            <div class="mb-3">
                                <label for="dueDate" class="form-label">Срок оплаты</label>
                                <input type="date" class="form-control" id="dueDate">
                            </div>
                        </div>
                    </div>

                    <!-- Панель 2: Реквизиты плательщика -->
                    <div class="card mb-3">
                        <div class="card-header">Банковские реквизиты плательщика</div>
                        <div class="card-body">
                    <div class="mb-3">
                                <label for="phone" class="form-label">Телефон</label>
                                <input 
                                    type="tel" 
                                    class="form-control" 
                                    id="phone" 
                                    pattern="\d+" 
                                    inputmode="numeric"
                                    maxlength="11"
                                >
                            </div>
                    <div class="mb-3">
                                <label for="inn" class="form-label">ИНН</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="inn" 
                                    pattern="\d{10,12}" 
                                    inputmode="numeric"
                                >
                            </div>
                    <div class="mb-3">
                                <label for="kpp" class="form-label">КПП</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="kpp" 
                                    pattern="\d{9}" 
                                    inputmode="numeric"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="legalAddress" class="form-label">Адрес</label>
                                <textarea class="form-control" id="legalAddress" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="companyName" class="form-label">Компания</label>
                                <input type="text" class="form-control" id="companyName">
                            </div>
                        </div>
                    </div>

                    <!-- Панель 3: Позиции -->
                    <div class="card">
                        <div class="card-header">Позиции</div>
                        <div class="card-body">
                            <div class="row mb-3 g-2">
                                <div class="col-md-2">
                                    <label for="itemType" class="form-label">Тип</label>
                                    <select class="form-select" id="itemType" onchange="updateTotal()">
                                        <option value="товар">Товар</option>
                        <option value="услуга">Услуга</option>
                    </select>
                </div>

                <div class="col-md-3">
                <label for="productName" class="form-label">Наименование товара</label>
                <input type="text" class="form-control" id="productName" oninput="updateTotal()">
                </div>

                <div class="col-md-2">
                    <label for="article" class="form-label">Артикул</label>
                    <input type="text" class="form-control" id="article" oninput="updateTotal()">
                </div>
                <div class="col-md-3">
                    <label for="description" class="form-label">Описание</label>
                    <input type="text" class="form-control" id="description" oninput="updateTotal()">
                </div>
                <div class="col-md-1">
                    <label for="price" class="form-label">Цена</label>
                    <input type="number" class="form-control" id="price" step="0.01" oninput="updateTotal()">
                </div>
                <div class="col-md-1">
                    <label for="quantity" class="form-label">Кол-во</label>
                    <input type="number" class="form-control" id="quantity" value="1" oninput="updateTotal()">
                </div>
                <div class="col-md-1">
                    <label for="vat" class="form-label">НДС</label>
                    <select class="form-select" id="vat" onchange="updateTotal()">
                        <option value="0">Без НДС</option>
                        <option value="0.05">5%</option>
                        <option value="0.07">7%</option>
                        <option value="0.10">10%</option>
                        <option value="0.22">22%</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" onclick="addItem()">Добавить</button>
                </div>
            </div>
            <div id="itemsList" class="mt-3"></div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="total" class="form-label">Итого:</label>
                    <input type="text" class="form-control" id="total" readonly value="0.00">
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
    <button type="button" class="btn btn-primary">Сохранить счёт</button>
    <input type="hidden" id="itemsJson" value="[]">
    <button type="button" class="btn btn-outline-success" id="savePdfBtn">Сохранить в PDF</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    let items = []; // Массив для хранения позиций

    function updateTotal() {
        const price = parseFloat(document.getElementById('price').value) || 0;
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        const vatRate = parseFloat(document.getElementById('vat').value) || 0;

        const subtotal = price * quantity;
        const vatAmount = subtotal * vatRate;
        const total = subtotal + vatAmount;

        document.getElementById('total').value = total.toFixed(2);
    }

    function addItem() {
        const itemType = document.getElementById('itemType').value;
        const article = document.getElementById('article').value;
        const description = document.getElementById('description').value;
        const price = parseFloat(document.getElementById('price').value) || 0;
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        const vatRate = parseFloat(document.getElementById('vat').value) || 0;

        const subtotal = price * quantity;
        const vatAmount = subtotal * vatRate;
        const total = subtotal + vatAmount;
        const itemId = Date.now();

        items.push({
            id: itemId,
            type: itemType,
            productName: document.getElementById('productName').value,
            article: article,
            description: description,
            price: price,
            quantity: quantity,
            vatRate: vatRate,
            total: total

        document.getElementById('itemsJson').value = JSON.stringify(items);
        });

        renderItemsList();
        updateGrandTotal();
    }

    function renderItemsList() {
        const itemsList = document.getElementById('itemsList');
        itemsList.innerHTML = '';

        items.forEach(item => {
            const row = document.createElement('div');
            row.className = 'row mb-2 align-items-center';
            row.innerHTML = `
                <div class="col-md-2">${item.type}</div>
                <div class="col-md-3">${item.productName}</div>
                <div class="col-md-2">${item.article}</div>
                <div class="col-md-3">${item.description}</div>
                <div class="col-md-1">${item.price.toFixed(2)}</div>
                <div class="col-md-1">${item.quantity}</div>
                <div class="col-md-1">${(item.vatRate * 100).toFixed(0)}%</div>
                <div class="col-md-1">${item.total.toFixed(2)}</div>
                <div class="col-md-1">
                    <button class="btn btn-sm btn-danger" onclick="removeItem(${item.id})">×</button>
                </div>
            `;
            itemsList.appendChild(row);
        });
    }

    function removeItem(itemId) {
        items = items.filter(item => item.id !== itemId);
        renderItemsList();
        updateGrandTotal();
        document.getElementById('itemsJson').value = JSON.stringify(items);
    }

    function updateGrandTotal() {
        const grandTotal = items.reduce((sum, item) => sum + item.total, 0);
        document.getElementById('total').value = grandTotal.toFixed(2);
    }

const numericInputs = [
    document.getElementById('phone'),
    document.getElementById('inn'),
    document.getElementById('kpp')
];

// Функция для очистки нечисловых символов
function allowOnlyDigits(e) {
    const input = e.target;
    input.value = input.value.replace(/[^0-9]/g, '');

    // Дополнительная проверка длины для каждого поля
    switch (input.id) {
        case 'phone':
            if (input.value.length > 11) input.value = input.value.slice(0, 11);
            break;
        case 'inn':
            if (input.value.length > 12) input.value = input.value.slice(0, 12);
            break;
        case 'kpp':
            if (input.value.length > 9) input.value = input.value.slice(0, 9);
            break;
    }
}




// Обработчик событий
numericInputs.forEach(input => {
    input.addEventListener('input', allowOnlyDigits);
    input.addEventListener('paste', allowOnlyDigits);
});

</script>